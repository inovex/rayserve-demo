apiVersion: apps/v1
kind: Deployment
metadata:
  name: locust
spec:
  replicas: 1
  selector:
    matchLabels:
      app: locust
  template:
    metadata:
      labels:
        app: locust
    spec:
      containers:
        - name: locust
          image: locustio/locust
          ports:
            - containerPort: 8089
          volumeMounts:
            - name: locust-script
              mountPath: /mnt/locust
          command: ["locust"]
          args: ["-f", "/mnt/locust/locustfile.py", "--host", "http://rayserve-demo-head-svc:8000"]
          readinessProbe:                                                                                                                                                                                                                                                                                                     
            httpGet:                                                                                                                                                                                                                                                                                                           
              path: /                                                                                                                                                                                                                                                                                                         
              port: 8089                                                                                                                                                                                                                                                                                                      
            initialDelaySeconds: 5                                                                                                                                                                                                                                                                                            
            periodSeconds: 5                                                                                                                                                                                                                                                                                                  
          livenessProbe:                                                                                                                                                                                                                                                                                                      
            httpGet:                                                                                                                                                                                                                                                                                                          
              path: /                                                                                                                                                                                                                                                                                                         
              port: 8089                                                                                                                                                                                                                                                                                                      
            initialDelaySeconds: 10                                                                                                                                                                                                                                                                                            
            periodSeconds: 10           
      volumes:
        - name: locust-script
          configMap:
            name: locust-script
---
apiVersion: v1
kind: Service
metadata:
  name: locust
spec:
  type: NodePort
  selector:
    app: locust
  ports:
    - port: 8089
      targetPort: 8089
      nodePort: 30089
